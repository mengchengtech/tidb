package interceptor_test

import (
	"strings"
	"testing"
	"time"

	// 强制调用preps包里的init方法

	"github.com/pingcap/failpoint"
	"github.com/pingcap/tidb/pkg/kv"
	"github.com/pingcap/tidb/pkg/mctech/interceptor"
	"github.com/pingcap/tidb/pkg/mctech/mock"
	"github.com/pingcap/tidb/pkg/parser/auth"
	"github.com/pingcap/tidb/pkg/testkit"
	"github.com/stretchr/testify/require"
)

// | id | estRows | estCost | actRows | task | access object | execution info | operator info | memory  | disk |

// | id                               | estRows  | estCost     | actRows | task      | access object                                                                             | execution info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | operator info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | memory  | disk     |
// | Sort_16                          | 77.78    | 2312979.73  | 8421    | root      |                                                                                           | time:1m47.2s, loops:10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | global_ec3.project_construction_quantity_contract_bill_part.level:desc, global_ec3.project_construction_quantity_contract_bill_part.order_no                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 3.48 MB | 0 Bytes  |
// | └─HashAgg_20                     | 77.78    | 2311513.94  | 8421    | root      |                                                                                           | time:1m47.2s, loops:17, partial_worker:{wall_time:1m47.17484498s, concurrency:16, task_num:38, tot_wait:28m33.683430141s, tot_exec:272.592059ms, tot_time:28m33.95901246s, max:1m47.124546249s, p95:1m47.124546249s}, final_worker:{wall_time:1m47.236099362s, concurrency:16, task_num:231, tot_wait:28m34.899401745s, tot_exec:96.339042ms, tot_time:28m34.995796917s, max:1m47.21733377s, p95:1m47.21733377s}                                                                                                                                                                         | group by:global_ec3.project_construction_quantity_contract_bill_part.construction_quantity_id, global_ec3.project_construction_quantity_contract_bill_part.current_bill_quantity, global_ec3.project_construction_quantity_contract_bill_part.entry_work_id, global_ec3.project_construction_quantity_contract_bill_part.entry_work_name, global_ec3.project_construction_quantity_contract_bill_part.id, global_ec3.project_construction_quantity_contract_bill_part.is_leaf, global_ec3.project_construction_quantity_contract_bill_part.level, global_ec3.project_construction_quantity_contract_bill_part.order_no, global_ec3.project_construction_quantity_contract_bill_part.org_id, global_ec3.project_construction_quantity_contract_bill_part.parent_id, global_ec3.project_construction_quantity_contract_bill_part.progress_item_id, global_ec3.project_construction_quantity_contract_bill_part.progress_item_name, global_ec3.project_construction_quantity_contract_bill_part.project_bill_quantity_detail_id, global_ec3.project_construction_quantity_contract_bill_part.project_part_id, global_ec3.project_construction_quantity_contract_bill_part.project_part_name, global_ec3.project_construction_quantity_contract_bill_part.project_unit_work_id, global_ec3.project_construction_quantity_contract_bill_part.project_unit_work_name, global_ec3.project_construction_quantity_contract_bill_part.quantity, global_ec3.project_construction_quantity_contract_bill_part.total_bill_quantity, global_ec3.project_construction_quantity_contract_bill_part.total_quantity, global_ec3.project_construction_quantity_contract_bill_part.unit, global_ec3.project_construction_quantity_contract_bill_part.unit_work_id, global_ec3.project_construction_quantity_contract_bill_part.value_type, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.id)->global_ec3.project_construction_quantity_contract_bill_part.id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.org_id)->global_ec3.project_construction_quantity_contract_bill_part.org_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.construction_quantity_id)->global_ec3.project_construction_quantity_contract_bill_part.construction_quantity_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.project_bill_quantity_detail_id)->global_ec3.project_construction_quantity_contract_bill_part.project_bill_quantity_detail_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.unit_work_id)->global_ec3.project_construction_quantity_contract_bill_part.unit_work_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.project_unit_work_id)->global_ec3.project_construction_quantity_contract_bill_part.project_unit_work_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.project_unit_work_name)->global_ec3.project_construction_quantity_contract_bill_part.project_unit_work_name, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.entry_work_id)->global_ec3.project_construction_quantity_contract_bill_part.entry_work_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.entry_work_name)->global_ec3.project_construction_quantity_contract_bill_part.entry_work_name, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.value_type)->global_ec3.project_construction_quantity_contract_bill_part.value_type, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.progress_item_id)->global_ec3.project_construction_quantity_contract_bill_part.progress_item_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.progress_item_name)->global_ec3.project_construction_quantity_contract_bill_part.progress_item_name, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.project_part_id)->global_ec3.project_construction_quantity_contract_bill_part.project_part_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.project_part_name)->global_ec3.project_construction_quantity_contract_bill_part.project_part_name, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.unit)->global_ec3.project_construction_quantity_contract_bill_part.unit, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.quantity)->global_ec3.project_construction_quantity_contract_bill_part.quantity, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.total_quantity)->global_ec3.project_construction_quantity_contract_bill_part.total_quantity, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.order_no)->global_ec3.project_construction_quantity_contract_bill_part.order_no, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.parent_id)->global_ec3.project_construction_quantity_contract_bill_part.parent_id, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.level)->global_ec3.project_construction_quantity_contract_bill_part.level, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.is_leaf)->global_ec3.project_construction_quantity_contract_bill_part.is_leaf, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.current_bill_quantity)->global_ec3.project_construction_quantity_contract_bill_part.current_bill_quantity, funcs:firstrow(global_ec3.project_construction_quantity_contract_bill_part.total_bill_quantity)->global_ec3.project_construction_quantity_contract_bill_part.total_bill_quantity | 27.5 MB | N/A      |
// |   └─HashJoin_25                  | 92.34    | 2311373.33  | 33612   | root      |                                                                                           | time:1m47.1s, loops:39, build_hash_table:{total:152.9ms, fetch:152ms, build:927.6µs}, probe:{concurrency:16, total:20m56.1s, max:1m47.1s, probe:20m51.6s, fetch:4.57s}                                                                                                                                                                                                                                                                                                                                                                                                                   | CARTESIAN inner join, other cond:gt(locate(cast(global_ec3.project_construction_quantity_contract_bill_part.id, var_string(100)), global_ec3.project_construction_quantity_contract_bill_part.full_id), 0)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 1.88 MB | 0 Bytes  |
// |     ├─IndexLookUp_35(Build)      | 1.02     | 1155080.67  | 8403    | root      |                                                                                           | time:151.4ms, loops:10, index_task: {total_time: 37.4ms, fetch_handle: 37.3ms, build: 61.7µs, wait: 15.1µs}, table_task: {total_time: 327.1ms, num: 7, concurrency: 16}, next: {wait_index: 55.3ms, wait_table_lookup_build: 0s, wait_table_lookup_resp: 67.6ms}                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 2.32 MB | N/A      |
// |     │ ├─IndexRangeScan_32(Build) | 39705.48 | 3177431.29  | 56588   | cop[tikv] | table:c_part, index:PRIMARY(tenant, org_id, id)                                           | time:30.8ms, loops:58, cop_task: {num: 1, max: 30.3ms, proc_keys: 0, tot_proc: 1.53µs, tot_wait: 60.7µs, rpc_num: 1, rpc_time: 30.3ms, copr_cache_hit_ratio: 1.00, build_task_duration: 30.3µs, max_distsql_concurrency: 1}, tikv_task:{time:32ms, loops:60}, scan_detail: {get_snapshot_time: 23.5µs, rocksdb: {block: {}}}                                                                                                                                                                                                                                                             | range:["cscrc" 1655078378418688,"cscrc" 1655078378418688], keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | N/A     | N/A      |
// |     │ └─Selection_34(Probe)      | 1.02     | 23271780.76 | 8403    | cop[tikv] |                                                                                           | time:296ms, loops:19, cop_task: {num: 7, max: 33ms, min: 20.4ms, avg: 22.6ms, p95: 33ms, max_proc_keys: 20480, p95_proc_keys: 20480, tot_proc: 31.5ms, tot_wait: 286.9µs, rpc_num: 7, rpc_time: 158ms, copr_cache_hit_ratio: 0.57, build_task_duration: 445.6µs, max_distsql_concurrency: 1}, tikv_task:{proc max:40ms, min:0s, avg: 16ms, p80:28ms, p95:40ms, iters:90, tasks:7}, scan_detail: {total_process_keys: 24544, total_process_keys_size: 11039346, total_keys: 24550, get_snapshot_time: 98.5µs, rocksdb: {key_skipped_count: 48927, block: {cache_hit_count: 485}}}         | eq(global_ec3.project_construction_quantity_contract_bill_part.construction_quantity_id, 1784483382014976), eq(global_ec3.project_construction_quantity_contract_bill_part.is_leaf, 1), eq(global_ec3.project_construction_quantity_contract_bill_part.is_removed, 0), eq(global_ec3.project_construction_quantity_contract_bill_part.project_bill_quantity_detail_id, 1670632461654168), ne(global_ec3.project_construction_quantity_contract_bill_part.quantity, 0)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | N/A     | N/A      |
// |     │   └─TableRowIDScan_33      | 39705.48 | 23152664.31 | 56588   | cop[tikv] | table:c_part                                                                              | tikv_task:{proc max:40ms, min:0s, avg: 16ms, p80:28ms, p95:40ms, iters:90, tasks:7}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | N/A     | N/A      |
// |     └─IndexLookUp_45(Probe)      | 90.86    | 1156221.29  | 24252   | root      |                                                                                           | time:242ms, loops:25, index_task: {total_time: 37.3ms, fetch_handle: 37.3ms, build: 8.37µs, wait: 12.9µs}, table_task: {total_time: 242ms, num: 7, concurrency: 16}, next: {wait_index: 55.3ms, wait_table_lookup_build: 0s, wait_table_lookup_resp: 105.4ms}                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 10.3 MB | N/A      |
// |       ├─IndexRangeScan_42(Build) | 39705.48 | 3177431.29  | 56588   | cop[tikv] | table:project_construction_quantity_contract_bill_part, index:PRIMARY(tenant, org_id, id) | time:33.8ms, loops:58, cop_task: {num: 1, max: 33.5ms, proc_keys: 0, tot_proc: 1.1µs, tot_wait: 39µs, rpc_num: 1, rpc_time: 33.5ms, copr_cache_hit_ratio: 1.00, build_task_duration: 10.1µs, max_distsql_concurrency: 1}, tikv_task:{time:32ms, loops:60}, scan_detail: {get_snapshot_time: 15.4µs, rocksdb: {block: {}}}                                                                                                                                                                                                                                                                | range:["cscrc" 1655078378418688,"cscrc" 1655078378418688], keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | N/A     | N/A      |
// |       └─Selection_44(Probe)      | 90.86    | 23271780.76 | 24252   | cop[tikv] |                                                                                           | time:199ms, loops:33, cop_task: {num: 7, max: 90.8ms, min: 9.05ms, avg: 22.7ms, p95: 90.8ms, max_proc_keys: 20480, p95_proc_keys: 20480, tot_proc: 57.7ms, tot_wait: 237.5µs, rpc_num: 7, rpc_time: 158.8ms, copr_cache_hit_ratio: 0.86, build_task_duration: 222.2µs, max_distsql_concurrency: 1}, tikv_task:{proc max:60ms, min:8ms, avg: 24.6ms, p80:40ms, p95:60ms, iters:90, tasks:7}, scan_detail: {total_process_keys: 20480, total_process_keys_size: 9196862, total_keys: 20484, get_snapshot_time: 79.1µs, rocksdb: {key_skipped_count: 40805, block: {cache_hit_count: 385}}} | eq(global_ec3.project_construction_quantity_contract_bill_part.construction_quantity_id, 1784483382014976), eq(global_ec3.project_construction_quantity_contract_bill_part.is_removed, 0), eq(global_ec3.project_construction_quantity_contract_bill_part.value_type, "part")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | N/A     | N/A      |
// |         └─TableRowIDScan_43      | 39705.48 | 23152664.31 | 56588   | cop[tikv] | table:project_construction_quantity_contract_bill_part                                    | tikv_task:{proc max:56ms, min:8ms, avg: 24ms, p80:40ms, p95:56ms, iters:90, tasks:7}

func TestFullSQLLog(t *testing.T) {
	failpoint.Enable("github.com/pingcap/tidb/pkg/config/GetMCTechConfig",
		mock.M(t, map[string]bool{"Metrics.SqlTrace.Enabled": true, "Tenant.Enabled": true}),
	)
	now := time.Now().Format("2006-01-02 15:04:05.000")
	failpoint.Enable("github.com/pingcap/tidb/pkg/mctech/interceptor/MockTraceLogData", mock.M(t, map[string]any{
		"startedAt": now, "mem": int64(151300), "disk": int64(9527), "keys": int(100), "rows": int64(1024), "affected": int64(1111),
	}))
	defer func() {
		failpoint.Disable("github.com/pingcap/tidb/pkg/config/GetMCTechConfig")
		failpoint.Disable("github.com/pingcap/tidb/pkg/mctech/interceptor/MockTraceLogData")
	}()
	store := testkit.CreateMockStore(t)
	tk := initDbAndData(t, store)

	sql := createTestSQL()
	tk.MustExec(sql)
	logData, err := interceptor.GetFullQueryTraceLog(tk.Session())
	require.NoError(t, err)
	require.NotNil(t, logData)

	require.Equal(t, map[string]any{
		"db": "global_ec3", "dbs": "global_ec3", "usr": "root", "tenant": "cscrc", "across": "",
		"conn": "1", "tp": "select",
		"at":   now,
		"time": map[string]any{"all": "3.315821ms", "tidb": "11.201s", "parse": "176.943µs", "plan": "1.417613ms", "cop": "128ms", "ready": "2.315821ms", "send": "1ms"},
		"mem":  float64(151300), "disk": float64(9527), "keys": float64(100), "affected": float64(1111), "rows": float64(1024),
		"digest": "422a8fb24253641cc985c5125d28b382eb4fe90c7ca01050e1e5dd0b39b2c673",
		"sql":    sql,
	}, logData)
}

func initMock(t *testing.T, store kv.Storage) *testkit.TestKit {
	tk := testkit.NewTestKit(t, store)
	tk.MustExec("drop database if exists global_ec3")
	tk.MustExec("create database global_ec3")
	tk.MustExec("use global_ec3")
	s := tk.Session()
	s.GetSessionVars().User = &auth.UserIdentity{Username: "root", Hostname: "%"}
	return tk
}

func initDbAndData(t *testing.T, store kv.Storage) *testkit.TestKit {
	tk := initMock(t, store)
	createSQL := strings.Join([]string{
		"CREATE TABLE `project_construction_quantity_contract_bill_part` (",
		"	`tenant` varchar(50) NOT NULL COMMENT '租户编码',",
		"	`org_id` bigint(20) NOT NULL COMMENT '组织id',",
		"	`id` bigint(20) NOT NULL COMMENT 'id',",
		"	`construction_quantity_id` bigint(20) NOT NULL COMMENT '施工完成id',",
		"	`construction_quantity_contract_bill_id` bigint(20) NOT NULL COMMENT '施工完成-原合同清单id',",
		"	`project_bill_quantity_detail_id` bigint(20) DEFAULT NULL COMMENT '原清单id',",
		"	`unit_work_id` bigint(20) DEFAULT NULL COMMENT 'wbs字典id',",
		"	`project_unit_work_id` bigint(20) DEFAULT NULL COMMENT '单位工程id',",
		"	`project_unit_work_name` varchar(255) DEFAULT NULL COMMENT '单位工程名称',",
		"	`progress_item_id` bigint(20) DEFAULT NULL COMMENT '形象进度id',",
		"	`progress_item_name` varchar(255) DEFAULT NULL COMMENT '形象进度名称',",
		"	`project_part_id` bigint(20) DEFAULT NULL COMMENT '部位id',",
		"	`project_part_name` varchar(255) DEFAULT NULL COMMENT '部位名称',",
		"	`unit` varchar(50) DEFAULT NULL COMMENT '单位',",
		"	`quantity` decimal(28,5) DEFAULT NULL COMMENT '完成形象量',",
		"	`total_quantity` decimal(28,5) DEFAULT NULL COMMENT '开累-形象量',",
		"	`current_bill_quantity` decimal(28,5) DEFAULT NULL COMMENT '本期数量',",
		"	`total_bill_quantity` decimal(28,5) DEFAULT NULL COMMENT '开累数量',",
		"	`order_no` bigint(20) NOT NULL COMMENT '排序',",
		"	`parent_id` bigint(20) NOT NULL COMMENT '父id',",
		"	`level` bigint(20) NOT NULL COMMENT '级别',",
		"	`full_id` varchar(255) NOT NULL COMMENT 'fullId',",
		"	`is_leaf` tinyint(1) DEFAULT NULL COMMENT '是否末级',",
		"	`is_removed` tinyint(1) NOT NULL DEFAULT '0' COMMENT '删除标记',",
		"	`creator` bigint(20) NOT NULL COMMENT '记录创建人',",
		"	`created_at` datetime NOT NULL COMMENT '记录创建时间',",
		"	`reviser` bigint(20) NOT NULL COMMENT '记录修改人',",
		"	`updated_at` datetime NOT NULL COMMENT '记录修改时间',",
		"	`version` bigint(20) NOT NULL COMMENT '记录版本号',",
		"	`value_type` varchar(50) DEFAULT NULL COMMENT '开项类型：entryWork || part',",
		"	`entry_work_id` bigint(20) DEFAULT NULL COMMENT '分部分项id',",
		"	`entry_work_name` varchar(255) DEFAULT NULL COMMENT '分部分项name',",
		"	PRIMARY KEY (`tenant`,`org_id`,`id`) /*T![clustered_index] NONCLUSTERED */",
		") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='施工完成量-原合同清单-形象进度/部位'",
	}, "\n")
	tk.MustExec(createSQL)
	return tk
}

func createTestSQL() string {
	return strings.Join([]string{
		"/* from:'ec-analysis-service', addr:'10.180.108.236' */",
		"/*& tenant:'cscrc' */",
		"WITH p_part AS (",
		"  SELECT",
		"    id,",
		"    org_id,",
		"    construction_quantity_id,",
		"    project_bill_quantity_detail_id,",
		"    unit_work_id,",
		"    project_unit_work_id,",
		"    project_unit_work_name,",
		"    entry_work_id,",
		"    entry_work_name,",
		"    value_type,",
		"    progress_item_id,",
		"    progress_item_name,",
		"    project_part_id,",
		"    project_part_name,",
		"    unit,",
		"    quantity,",
		"    total_quantity,",
		"    order_no,",
		"    parent_id,",
		"    LEVEL,",
		"    is_leaf,",
		"    current_bill_quantity,",
		"    total_bill_quantity",
		"  FROM",
		"    project_construction_quantity_contract_bill_part",
		"  WHERE",
		"    construction_quantity_id = 1784483382014976",
		"    AND org_id = 1655078378418688",
		"    AND is_removed = FALSE",
		")",
		"SELECT",
		"  DISTINCT p_part.*",
		"FROM",
		"  project_construction_quantity_contract_bill_part c_part",
		"  INNER JOIN p_part ON LOCATE(CAST(p_part.id AS CHAR(100)), c_part.full_id) > 0",
		"WHERE",
		"  c_part.construction_quantity_id = 1784483382014976",
		"  AND c_part.org_id = 1655078378418688",
		"  AND c_part.is_removed = FALSE",
		"  AND c_part.is_leaf = TRUE",
		"  AND IF(1670632461654168 > 0, 1 = 1, p_part.is_leaf = TRUE)",
		"  AND IF(",
		"    1670632461654168 > 0,",
		"    p_part.value_type = 'part',",
		"    1 = 1",
		"  )",
		"  AND IF(1670632461654168 > 0, c_part.quantity <> 0, 1 = 1)",
		"  AND IF(",
		"    1670632461654168 > 0,",
		"    c_part.project_bill_quantity_detail_id = 1670632461654168,",
		"    1 = 1",
		"  )",
		"ORDER BY",
		"  p_part.level DESC,",
		"  p_part.order_no",
	}, "\n")
}
